# 项目初始化

## 前期准备

一般来说，小程序在开发之前已经在微信申请。而一些工作需要在微信小程序的[管理界面](https://mp.weixin.qq.com/)来操作，这是一个微信的网页

![image-20230220114712560](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230220114712560.png)

### 添加为开发者

在成员管理菜单下添加开发者，这样就可以用小程序开发工具进行开发

![image-20230220114931001](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230220114931001.png)



### 下载微信开发者工具

![image-20230220115335752](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230220115335752.png)

[下载链接](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)

### 拉取空工程

项目提供一个demo项目可以使用,按照一下流程操作

#### 1.拉取项目

`git clone `

#### 2.修改appid，以及环境信息

appid是小程序的唯一身份标识，在小程序申请完成后，可以在小程序管理页面，设置菜单中查看

![image-20230220162246493](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230220162246493.png)



打开项目文件修改appid以及工程名称

![image-20230220162003436](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230220162003436.png)

#### 3.使用微信开发者工具打开

![image-20230223152504375](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230223152504375.png)

#### 4.下依赖

![image-20230223152419850](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230223152419850.png)

#### 5.构建npm

![image-20230223152623675](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230223152623675.png)

#### 6.启动

开发时有缓存先清理缓存，无缓存则直接编译启动

![image-20230223152708333](https://typora-huang-cong.oss-cn-shanghai.aliyuncs.com/image-20230223152708333.png)





# 通用组件

## 页面构建组件

司机端小程序开发的常用组件除了vant之外，还有一些自定组件

### Card

### CardButton

### CardField

### CardFooter

### CardHeader

### date-picker

### empty

### FooterButton

### imageUpload

### lov-picker

### message

### output

### PageFooter

### Step

## 列表页模板

小程序的常用页面类型。

![页面类型](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/fdece428955c44f2b6631573487859f7%40%E6%97%A0%E6%A0%87%E9%A2%9815.png)

- 普通列表页 [页面模板](https://handtms-static.obs.cn-east-3.myhuaweicloud.com:443/component/0/4aae5bca8aa0463bad401bf5d0a3ed1c@simpleList.rar)
- 普通 tab 列表页 [页面模板](https://handtms-static.obs.cn-east-3.myhuaweicloud.com:443/component/0/c36c23c66a804effac3335080c7b6ef0@simpleTapsList.rar)
- 带搜索的 tab 列表页 [页面模板](https://handtms-static.obs.cn-east-3.myhuaweicloud.com:443/component/0/1984379e3730412fb4aaa0a69ed4e7fa@searchSimpleTapsList.rar)
- 带搜索的列表页 [页面模板](https://handtms-static.obs.cn-east-3.myhuaweicloud.com:443/component/0/c20c77f2b4d74a56b2d124925487c35f@searchSimpleList.rar)
- 表单页

### 使用模板页面开发需要以下三个步骤 

1.选择适合的模板放入小程序

普通列表页 [页面模板](https://handtms-static.obs.cn-east-3.myhuaweicloud.com:443/component/0/4aae5bca8aa0463bad401bf5d0a3ed1c@simpleList.rar)

如果此时没有在TMS运输管理系统维护子应用，我们可以使用小程序开发工具的本地编译，编译特定页面。

首先在app.json将页面路径写入页面配置（示例放入了page,如果是客户自定义页面，则放入subpackages）,另外暂时注释调app.js的强制路由跳转代码（因为每次启动小程序首先会执行app.js,如果不注释调跳转，会使本地编译的页面无法达到）。



![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/9390ff374b6d4399a506dec0f3c5dc7d%40%E6%97%A0%E6%A0%87%E9%A2%9825.png)



然后，设置本地编译模式，填写页面路由，编译页面。调试完成后，恢复app.js注释的代码

![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/4d8136ab52b8450294c16f6abf4b2b18%40%E6%97%A0%E6%A0%87%E9%A2%9824.png)



![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/080a161dbda24281b1380942e11723d3%40%E6%97%A0%E6%A0%87%E9%A2%9826.png)



![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/e3dfbdfcee474dce8fefe4b36c6de9b9%40%E6%97%A0%E6%A0%87%E9%A2%9827.png)



2.修改数据源

确认页面import路径正确，并且修改请求路径，如下图所示（注意：所有请求地址写在common/http文件中）

![页面js](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/8e69366cc2d5499bb49eaec71f61b9d3%40%E6%97%A0%E6%A0%87%E9%A2%9822.png)



3.修改页面内容

修改页面中卡片的内容，包扩CardHeader,CardFooter,以及`<view slot="mid">`

![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/8c5884e1e9e3485abb15dcb3a0d8283d%40%E6%97%A0%E6%A0%87%E9%A2%9823.png)



![](https://handtms-static.obs.cn-east-3.myhuaweicloud.com/component/0/e3dfbdfcee474dce8fefe4b36c6de9b9%40%E6%97%A0%E6%A0%87%E9%A2%9827.png)

# 通用方法

小程序的通用方法在utils文件夹的util文件和extraFeat文件导出，其中，util文件是一些通用的小程序的方法；而extraFeat的内容是与hzero相关的方法，例如，获取坐标，逆向地址解析，获取值集，获取lov，宏的请求方法

## util



### promisify（这个方法包装小程序的回调API很有用）

转化微信的大多数方法，wx.xxx的条件，在很多时候是以下形式，使用此方法，可以将其转化为promise

```javascript
{
    success:xxx,
    fail:xxx,
        ......
}
```

代码

```javascript
/**
 * @description promisify
 * @param {*} 函数 fun({success:xxx,fail:xxx})
 * @return {*} promise化的函数
 */
function promisify(func) {
  return (options = {}) =>
    new Promise((resolve, reject) => {
      options.success = resolve;
      options.fail = reject;

      func(options);
    });
}
```

示例

```javascript
// 
const { result } = await promisify(wx.scanCode)();
```



### wrapRequest

对请求类的wxApi包装，如wx.request,wx.uploadImage等等。在此方法中有对loading的全局控制，对网关的读取，请求日志打印（体验版），以及对错误的处理。

代码

```
/**
 * @description 将网络请求类的函数promisify，效果是响应数据预先处理，有loading控制，可以充当请求处理器
 * @options raw 返回原始的响应，对于某些格式不太规范或者是云服务的请求需要这么做
 * @options loading 控制loading是否显示，注意：只对配置了此项的请求有用，有多个请求时，需分别配置
 * @exception 此方法不抛出异常，错误信息内部处理展示
 * @param {*} 函数 fun({success:xxx,fail:xxx})
 * @return {*} promise化的函数
 * @example
 *  wrapRequest(wx.request)
 *  wrapRequest(wx.uploadFile)
 *  wrapRequest(wx.downloadFile)
 * ...
 */
function wrapRequest(func) {

	...
}
```



参数

* 微信请求类方法



```javascript
const request = wrapRequest(wx.request)

// options使用wx.request的原本参数
request(option)

const uploadFile = wrapRequest(wx.uploadFile)
// options使用wx.request的原本参数
uploadFile(options)

const downloadFile =wrapRequest(wx.downloadFile)
// options使用wx.request的原本参数
downloadFile(options)
```



### request

使用wrapRequest工具方法包装微信请求方法后，暴露的请求方法。此方法用于发送请求

代码

```javascript
const request = wrapRequest(wx.request);
```



示例

```javascript
import {request} from '../../utils/util'

Page({
 
    
    async querySomething(){
        
        // 参数
       const options = {
    		url:'getShipment',
    		method:"GET"
		}
       // 请求
       const {success,data,message} = await request(options) 
       
       
       
    }
})
```





### mergeObj

浅合并两个对象

代码

```javascript
/**
 * @description 浅合并两个对象
 * @param {*}
 * @return {*}
 * 使用方法
 * @example
 * 例如：b合到a
 * mergeObj(a)(b)
 */
function mergeObj(target) {
  if (!isObject(target)) throw new Error(`${target} isn't a plain object`);
  return (merge) => {
    if (!isObject(merge)) throw new Error(`${merge} isn't a plain object`);
    Object.entries(merge).forEach(([key, value]) => {
      target[key] = value;
    });
  };
}
```



用法

```javascript
const inner = {
    searchParms:""
}

console.log(inner.searchParms)// ""

// 这么做就可以合并把searchParms的值合并到inner对象
mergeObj(this.inner)({searchParms:521})

console.log(inner.searchParms)// 521

```





### getDataSet

获取微信点击事件传递的参数

代码

```javascript
/**
 * @description 获取组件上的dataset信息
 * @param {*}
 * @return {*}
 * @example
 * 使用方式
 *
 * <view bindtab="handleCilck"></view>
 *
 * function handleCilck(e){
 *  const dataSet = getDataSet(e)
 * }
 */
function getDataSet(e) {
  const {
    currentTarget: { dataset },
  } = e;
  return dataset;
}	
```

示例

在页面中有需要传递参数时往往会绑定点击事件，并设置参数data-参数名

```xml
<view bindtab="handleCilck" data-id="521"></view>
```
在绑定的事件中就可以直接获取传递的参数

```javascript
function handleCilck(e){
    
    const {id} = getDataSet(e)
    
    console.log(id) // 521
}
```



### goback

返回上一级页面,并显示消息

代码

```javascript
/**
 * @description 回到上一页，并在回去后显示消息（可选）
 * @param {*} msg
 * @return {*}
 * @example goback()
 * @example goback("签到成功")
 */
async function goback(msg, delta = 1) {
  await promisify(wx.navigateBack)({ delta });
  if (!msg) return;
  setTimeout(() => {
    showWxMsg(msg);
  }, 200);
}
```

示例

```javascript
// 返回上一级
goback()

// 返回到上一级，并且在上一级显示 ‘任务已提交’
goback("任务已提交")

```



### showWxMsg

封装微信提示信息，等待信息提示完成之后，再继续执行某些操作

代码

```javascript
/**
 * @description 微信提示信息
 * @param {string} msg 要显示的消息
 * @param {string} icon 显示图标
 * @return {*}
 * @example showWxMsg('加载成功')
 * @example showWxMsg('加载失败','error')
 */
async function showWxMsg(msg, icon = "success", duration = 1500) {
  wx.showToast({
    title: msg,
    icon,
    duration,
  });
  return await new Promise(function (resolve) {
    let id = setTimeout(() => {
      resolve();
      clearTimeout(id);
    }, duration);
  });
}
```



示例

```javascript
 // 提示执行成功
showWxMsg('执行成功')
// 提示执行失败
showWxMsg('执行失败','error')

// 控制显示时长,3000毫秒
showWxMsg('执行失败','error',3000)

```

promise用法，消息显示完成之后promise会resolve

```javascript

async someEvent(){
 // do something
   
    // 显示消息
   await showWxMsg("执行成功")
    
    // 显示完成后 do something ，比方说，跳转到什么页面
    
    jumpToOtherPage()
    
    
}

```









### getParent

获取上一个页面的实例

代码

```javascript
/**
 * @description 获取上一个页面的页面对象，直接操作Page实例
 * @param {*}
 * @return {*}
 * @example
 * const parent = getParent()
 * parent.queryInfo();
 * parent.setData({
 *    a:1
 * });
 */
function getParent() {
  const pages = getCurrentPages();
  return pages[pages.length - 2];
}
```

用法

```javascript
function midifySomeData(){
    
    const parent = getParent()

    // 改变父页面的渲染数据
    parent.setData({userName:"xxx"})
    // 改变父页面的内部数据
    mergeObj(parent.inner)({metaData:{a:1}})
    // 调用父页面的方法
    parent.excuteMethodA()
    

}
```

### formatTime

格式化时间，讲时间对象格式化为字符串



代码

```javascript
/**
 * @description 普通格式化日期
 * @param {*}
 * @return {*}
 * @example
 *  formatTime(new Date()) => 2020-12-11 21:11:22
 */

function formatTime(date, isDate) {
  if (!date) date = new Date();
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hour = date.getHours();
  const minute = date.getMinutes();
  const second = date.getSeconds();
  if (isDate) {
    return [year, month, day].map(formatNumber).join("-");
  }
  return (
    [year, month, day].map(formatNumber).join("-") +
    " " +
    [hour, minute, second].map(formatNumber).join(":")
  );
}
```

使用

```javascript
// 格式化当前时间
const timeString = formatTime()

console.log(timeString)  // 2023-02-23 23:23:23

// 格式化固定时间
const time = new Date("2022-02-22 22:22:22")
const timeString =formatTime(time)
console.log(timeString)  // 2022-02-22 22:22:22

// 只获取年月日
const time = new Date("2022-02-22 22:22:22",true)
const timeString =formatTime(time)
console.log(timeString)  // 2022-02-22

```



### getDateTime

### getTimepiece

### isPhone

### debounce

### setManyGlobal

### getGlobalData



### getMacroMsg

## extraFeat

### getAddress

### getLocation

### getlookUpCode

### getLov

### macroRequest

### getSubAppParameterByCode

### bdgcj2String

